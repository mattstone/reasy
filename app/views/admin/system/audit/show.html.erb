<div class="admin-content">
  <%# Page Header %>
  <div class="admin-page-header">
    <div>
      <h1 class="admin-page-title">Audit Activity</h1>
      <p class="admin-page-subtitle">Action logs, user activity, and impersonation tracking</p>
    </div>
    <div class="admin-section-nav">
      <%= link_to "System Status", admin_system_root_path, class: "admin-section-nav-item" %>
      <%= link_to "Platform Usage", admin_system_usage_path, class: "admin-section-nav-item" %>
      <%= link_to "AI Analytics", admin_system_ai_path, class: "admin-section-nav-item" %>
      <%= link_to "Audit Activity", admin_system_audit_path, class: "admin-section-nav-item active" %>
    </div>
  </div>

  <%# Hero Metrics %>
  <div class="admin-metric-hero">
    <div class="admin-metric-hero-card">
      <div class="admin-metric-hero-card-icon blue">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
      </div>
      <div class="admin-metric-hero-value"><%= number_with_delimiter(@actions_today) %></div>
      <div class="admin-metric-hero-label">Actions Today</div>
      <div class="admin-metric-hero-change neutral">Audit log entries</div>
    </div>

    <div class="admin-metric-hero-card">
      <div class="admin-metric-hero-card-icon green">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
        </svg>
      </div>
      <div class="admin-metric-hero-value"><%= number_with_delimiter(@actions_this_week) %></div>
      <div class="admin-metric-hero-label">This Week</div>
      <div class="admin-metric-hero-change neutral">Last 7 days</div>
    </div>

    <div class="admin-metric-hero-card">
      <div class="admin-metric-hero-card-icon orange">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
        </svg>
      </div>
      <div class="admin-metric-hero-value"><%= number_with_delimiter(@unique_users_today) %></div>
      <div class="admin-metric-hero-label">Active Users Today</div>
      <div class="admin-metric-hero-change neutral">Unique users</div>
    </div>

    <div class="admin-metric-hero-card">
      <div class="admin-metric-hero-card-icon purple">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
          <path d="M16 11h6"/>
        </svg>
      </div>
      <div class="admin-metric-hero-value"><%= number_with_delimiter(@impersonation_sessions) %></div>
      <div class="admin-metric-hero-label">Impersonations (7d)</div>
      <div class="admin-metric-hero-change neutral">Admin sessions</div>
    </div>
  </div>

  <%# Charts and Stats %>
  <div class="admin-grid-2 mb-6">
    <div class="admin-chart-card">
      <div class="admin-chart-card-header">
        <div>
          <h3 class="admin-chart-card-title">Activity by Hour</h3>
          <p class="admin-chart-card-subtitle">Last 7 days</p>
        </div>
      </div>
      <div class="admin-chart-container"
           data-controller="d3-chart"
           data-d3-chart-type-value="bar"
           data-d3-chart-data-value="<%= @hourly_activity.map { |d| { label: d[:x], value: d[:value] } }.to_json %>"
           data-d3-chart-height-value="200"
           data-d3-chart-colors-value='["#3b82f6"]'>
      </div>
    </div>

    <div class="admin-chart-card">
      <div class="admin-chart-card-header">
        <div>
          <h3 class="admin-chart-card-title">Activity by Role</h3>
          <p class="admin-chart-card-subtitle">User type distribution</p>
        </div>
      </div>
      <div class="admin-chart-container"
           data-controller="d3-chart"
           data-d3-chart-type-value="donut"
           data-d3-chart-data-value="<%= [
             { label: 'Buyers', value: @by_role[:buyers], color: '#3b82f6' },
             { label: 'Sellers', value: @by_role[:sellers], color: '#22c55e' },
             { label: 'Providers', value: @by_role[:providers], color: '#f59e0b' },
             { label: 'Admins', value: @by_role[:admins], color: '#8b5cf6' }
           ].to_json %>"
           data-d3-chart-height-value="200">
      </div>
    </div>
  </div>

  <%# Top Actions and Resource Types %>
  <div class="admin-grid-2 mb-6">
    <div class="admin-panel">
      <div class="admin-panel-header">
        <h2 class="admin-panel-title">Top Actions (7 days)</h2>
      </div>
      <div class="admin-panel-content">
        <ul class="admin-data-list">
          <% @top_actions.each do |action, count| %>
            <li class="admin-data-list-item">
              <div class="admin-data-list-bar">
                <span class="admin-data-list-label"><%= action.gsub('.', ' ').humanize %></span>
                <% max_count = @top_actions.values.max || 1 %>
                <div class="admin-data-list-bar-fill" style="width: <%= (count.to_f / max_count * 100).round %>px;"></div>
              </div>
              <span class="admin-data-list-value"><%= number_with_delimiter(count) %></span>
            </li>
          <% end %>
          <% if @top_actions.empty? %>
            <li class="admin-data-list-item text-muted">No activity recorded</li>
          <% end %>
        </ul>
      </div>
    </div>

    <div class="admin-panel">
      <div class="admin-panel-header">
        <h2 class="admin-panel-title">By Resource Type</h2>
      </div>
      <div class="admin-panel-content">
        <ul class="admin-data-list">
          <% @by_resource.each do |resource, count| %>
            <li class="admin-data-list-item">
              <span class="admin-data-list-label"><%= resource %></span>
              <span class="admin-data-list-value"><%= number_with_delimiter(count) %></span>
            </li>
          <% end %>
          <% if @by_resource.empty? %>
            <li class="admin-data-list-item text-muted">No resources tracked</li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>

  <%# Recent Activity and Impersonations %>
  <div class="admin-grid-2">
    <div class="admin-panel">
      <div class="admin-panel-header">
        <h2 class="admin-panel-title">Recent Activity</h2>
        <%= link_to "View All", admin_audit_logs_path, class: "btn btn-ghost btn-sm" %>
      </div>
      <% if @recent_entries.any? %>
        <ul class="recent-activity-list" style="max-height: 400px; overflow-y: auto;">
          <% @recent_entries.each do |entry| %>
            <li class="recent-activity-item">
              <div class="recent-activity-info">
                <span class="recent-activity-name"><%= entry.action_type.gsub('.', ' ').humanize %></span>
                <span class="recent-activity-meta">
                  <%= entry.user&.name || "System" %> &bull; <%= entry.resource_type %>
                </span>
              </div>
              <span class="recent-activity-time"><%= time_ago_in_words(entry.created_at) %> ago</span>
            </li>
          <% end %>
        </ul>
      <% else %>
        <div class="admin-panel-content text-center py-6">
          <p class="text-muted">No recent activity</p>
        </div>
      <% end %>
    </div>

    <div class="admin-panel">
      <div class="admin-panel-header">
        <h2 class="admin-panel-title">Impersonation Log</h2>
      </div>
      <% if @recent_impersonations.any? %>
        <ul class="recent-activity-list">
          <% @recent_impersonations.each do |entry| %>
            <li class="recent-activity-item">
              <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-accent); flex-shrink: 0;"></div>
              <div class="recent-activity-info">
                <span class="recent-activity-name">
                  <%= entry.impersonated_by&.name || "Admin" %> as <%= entry.user&.name || "User" %>
                </span>
                <span class="recent-activity-meta"><%= entry.action_type.gsub('.', ' ').humanize %></span>
              </div>
              <span class="recent-activity-time"><%= time_ago_in_words(entry.created_at) %> ago</span>
            </li>
          <% end %>
        </ul>
      <% else %>
        <div class="admin-panel-content text-center py-6">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--color-success-pale0)" stroke-width="2" style="margin: 0 auto var(--space-3);">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <p class="text-muted">No impersonation sessions recorded</p>
        </div>
      <% end %>
    </div>
  </div>
</div>
