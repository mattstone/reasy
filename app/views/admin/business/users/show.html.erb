<div class="admin-content">
  <%# Page Header %>
  <div class="admin-page-header">
    <div>
      <h1 class="admin-page-title">User Growth Analytics</h1>
      <p class="admin-page-subtitle">Signups, roles, and KYC completion metrics</p>
    </div>
    <div class="admin-section-nav">
      <%= link_to "Overview", admin_business_root_path, class: "admin-section-nav-item" %>
      <%= link_to "Revenue", admin_business_revenue_path, class: "admin-section-nav-item" %>
      <%= link_to "User Growth", admin_business_users_path, class: "admin-section-nav-item active" %>
      <%= link_to "Transactions", admin_business_transactions_path, class: "admin-section-nav-item" %>
    </div>
  </div>

  <%# Hero Metrics %>
  <div class="admin-metric-hero">
    <div class="admin-metric-hero-card">
      <div class="admin-metric-hero-card-icon blue">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
      </div>
      <div class="admin-metric-hero-value"><%= number_with_delimiter(@total_users) %></div>
      <div class="admin-metric-hero-label">Total Users</div>
      <div class="admin-metric-hero-change neutral">All registered accounts</div>
    </div>

    <div class="admin-metric-hero-card">
      <div class="admin-metric-hero-card-icon green">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </div>
      <div class="admin-metric-hero-value"><%= number_with_delimiter(@new_users_this_week) %></div>
      <div class="admin-metric-hero-label">New This Week</div>
      <div class="admin-metric-hero-change positive">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg>
        Last 7 days
      </div>
    </div>

    <div class="admin-metric-hero-card">
      <div class="admin-metric-hero-card-icon orange">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
      </div>
      <div class="admin-metric-hero-value"><%= number_with_delimiter(@active_users_today) %></div>
      <div class="admin-metric-hero-label">Active Today</div>
      <div class="admin-metric-hero-change neutral">Logged in today</div>
    </div>

    <div class="admin-metric-hero-card">
      <div class="admin-metric-hero-card-icon purple">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>
      <div class="admin-metric-hero-value"><%= @kyc_completion_rate %>%</div>
      <div class="admin-metric-hero-label">KYC Completion</div>
      <div class="admin-metric-hero-change neutral">Verified users</div>
    </div>
  </div>

  <%# Charts and Distribution %>
  <div class="admin-grid-2 mb-6">
    <div class="admin-chart-card">
      <div class="admin-chart-card-header">
        <div>
          <h3 class="admin-chart-card-title">Daily Signups</h3>
          <p class="admin-chart-card-subtitle">Last 30 days</p>
        </div>
      </div>
      <div class="admin-chart-container"
           data-controller="d3-chart"
           data-d3-chart-type-value="bar"
           data-d3-chart-data-value="<%= @daily_signups.map { |d| { label: Date.parse(d[:date]).strftime('%b %d'), value: d[:value] } }.to_json %>"
           data-d3-chart-height-value="250"
           data-d3-chart-colors-value='["#3b82f6"]'>
      </div>
    </div>

    <div class="admin-chart-card">
      <div class="admin-chart-card-header">
        <div>
          <h3 class="admin-chart-card-title">Users by Role</h3>
          <p class="admin-chart-card-subtitle">Distribution</p>
        </div>
      </div>
      <div class="admin-chart-container"
           data-controller="d3-chart"
           data-d3-chart-type-value="donut"
           data-d3-chart-data-value="<%= [
             { label: 'Buyers', value: @users_by_role[:buyers], color: '#3b82f6' },
             { label: 'Sellers', value: @users_by_role[:sellers], color: '#22c55e' },
             { label: 'Providers', value: @users_by_role[:service_providers], color: '#f59e0b' },
             { label: 'Admins', value: @users_by_role[:admins], color: '#8b5cf6' }
           ].to_json %>"
           data-d3-chart-height-value="250">
      </div>
    </div>
  </div>

  <%# User Funnel and KYC Stats %>
  <div class="admin-grid-2">
    <div class="admin-chart-card">
      <div class="admin-chart-card-header">
        <div>
          <h3 class="admin-chart-card-title">User Funnel</h3>
          <p class="admin-chart-card-subtitle">Conversion stages</p>
        </div>
      </div>
      <div class="admin-chart-container"
           data-controller="d3-chart"
           data-d3-chart-type-value="funnel"
           data-d3-chart-data-value="<%= @funnel_data.to_json %>"
           data-d3-chart-height-value="300">
      </div>
    </div>

    <div class="admin-panel">
      <div class="admin-panel-header">
        <h2 class="admin-panel-title">KYC Status Breakdown</h2>
      </div>
      <div class="admin-panel-content">
        <ul class="admin-data-list">
          <% @kyc_stats.each do |status, count| %>
            <li class="admin-data-list-item">
              <div class="admin-data-list-bar">
                <span class="admin-data-list-label"><%= status&.humanize || "None" %></span>
                <% max_count = @kyc_stats.values.max || 1 %>
                <div class="admin-data-list-bar-fill" style="width: <%= (count.to_f / max_count * 150).round %>px; background: <%= status == 'verified' ? 'var(--color-success-pale0)' : 'var(--color-primary-pale0)' %>;"></div>
              </div>
              <span class="admin-data-list-value"><%= number_with_delimiter(count) %></span>
            </li>
          <% end %>
        </ul>
      </div>

      <div class="admin-panel-header" style="margin-top: var(--space-4); border-top: 1px solid var(--color-gray-100);">
        <h2 class="admin-panel-title">Role Distribution</h2>
      </div>
      <div class="admin-panel-content">
        <ul class="admin-data-list">
          <li class="admin-data-list-item">
            <span class="admin-data-list-label">Buyers</span>
            <span class="admin-data-list-value"><%= number_with_delimiter(@users_by_role[:buyers]) %></span>
          </li>
          <li class="admin-data-list-item">
            <span class="admin-data-list-label">Sellers</span>
            <span class="admin-data-list-value"><%= number_with_delimiter(@users_by_role[:sellers]) %></span>
          </li>
          <li class="admin-data-list-item">
            <span class="admin-data-list-label">Service Providers</span>
            <span class="admin-data-list-value"><%= number_with_delimiter(@users_by_role[:service_providers]) %></span>
          </li>
          <li class="admin-data-list-item">
            <span class="admin-data-list-label">Admins</span>
            <span class="admin-data-list-value"><%= number_with_delimiter(@users_by_role[:admins]) %></span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
