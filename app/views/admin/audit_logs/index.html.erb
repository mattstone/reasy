<div class="admin-content">
  <%# Page Header %>
  <div class="admin-page-header">
    <div>
      <h1 class="admin-page-title">Audit Logs</h1>
      <p class="admin-page-subtitle">Track system activity and changes</p>
    </div>
    <div>
      <%= link_to export_admin_audit_logs_path(format: :csv), class: "btn btn-secondary" do %>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Export CSV
      <% end %>
    </div>
  </div>

  <%# Filters %>
  <div class="admin-panel mb-4">
    <div class="admin-panel-content">
      <%= form_with url: admin_audit_logs_path, method: :get, local: true do |f| %>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--reasy-space-4);">
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Action Type</label>
            <select name="action_type" class="form-control form-control-sm">
              <option value="">All Actions</option>
              <option value="create" <%= 'selected' if params[:action_type] == 'create' %>>Create</option>
              <option value="update" <%= 'selected' if params[:action_type] == 'update' %>>Update</option>
              <option value="delete" <%= 'selected' if params[:action_type] == 'delete' %>>Delete</option>
              <option value="login" <%= 'selected' if params[:action_type] == 'login' %>>Login</option>
              <option value="logout" <%= 'selected' if params[:action_type] == 'logout' %>>Logout</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">From Date</label>
            <input type="date" name="date_from" value="<%= params[:date_from] %>" class="form-control form-control-sm">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">To Date</label>
            <input type="date" name="date_to" value="<%= params[:date_to] %>" class="form-control form-control-sm">
          </div>
          <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end;">
            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
            <% if params[:action_type].present? || params[:date_from].present? || params[:date_to].present? %>
              <%= link_to "Clear", admin_audit_logs_path, class: "btn btn-ghost btn-sm ml-2" %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%# Audit Logs List %>
  <div class="admin-panel">
    <% if @audit_logs.any? %>
      <% @audit_logs.each do |log| %>
        <div class="audit-log-entry">
          <div class="audit-log-header">
            <span class="audit-log-action">
              <span class="badge badge-sm <%= log.action == 'create' ? 'badge-green' : (log.action == 'delete' ? 'badge-red' : 'badge-blue') %>">
                <%= log.action&.upcase || "ACTION" %>
              </span>
              <%= log.resource_type&.humanize || "Resource" %>
              <% if log.resource_id %>
                #<%= log.resource_id %>
              <% end %>
            </span>
            <span class="audit-log-time"><%= log.created_at.strftime("%B %d, %Y at %I:%M:%S %p") %></span>
          </div>
          <div class="audit-log-details">
            <% if log.changes_made.present? %>
              <% log.changes_made.each do |field, values| %>
                <span style="display: inline-block; margin-right: var(--reasy-space-3);">
                  <strong><%= field.humanize %>:</strong>
                  <% if values.is_a?(Array) && values.length == 2 %>
                    <span style="text-decoration: line-through; color: var(--reasy-red-500);"><%= values[0] %></span>
                    →
                    <span style="color: var(--reasy-green-600);"><%= values[1] %></span>
                  <% else %>
                    <%= values %>
                  <% end %>
                </span>
              <% end %>
            <% else %>
              <%= log.description || "No details available" %>
            <% end %>
          </div>
          <div class="audit-log-user">
            <% if log.user %>
              By <%= link_to log.user.name, admin_user_path(log.user) %> (<%= log.user.email %>)
            <% else %>
              System
            <% end %>
            <% if log.ip_address.present? %>
              · IP: <%= log.ip_address %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="admin-panel-content" style="text-align: center; padding: var(--reasy-space-8);">
        <p class="text-muted">No audit logs found.</p>
      </div>
    <% end %>

    <%# Pagination %>
    <% if @pagy.pages > 1 %>
      <div class="pagination-wrapper">
        <%== pagy_nav(@pagy) %>
      </div>
    <% end %>
  </div>
</div>
