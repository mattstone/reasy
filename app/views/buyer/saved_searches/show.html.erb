<div class="layout">
  <%= render "shared/dashboard_sidebar" %>

  <main class="layout-main">
    <div class="content">
      <%# Page Header %>
      <div class="page-header">
        <div class="page-header-content">
          <%= link_to buyer_saved_searches_path, class: "back-link" do %>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m15 18-6-6 6-6"/>
            </svg>
            Back to Saved Searches
          <% end %>
          <h1 class="page-title"><%= @saved_search.name %></h1>
          <p class="page-subtitle"><%= search_criteria_summary(@saved_search) %></p>
        </div>
        <div class="page-header-actions">
          <%= link_to edit_buyer_saved_search_path(@saved_search), class: "btn btn-secondary" do %>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
            </svg>
            Edit Search
          <% end %>
          <%= button_to buyer_saved_search_path(@saved_search),
                method: :delete,
                class: "btn btn-ghost text-danger",
                data: { turbo_confirm: "Are you sure you want to delete this search?" } do %>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18"/>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            </svg>
            Delete
          <% end %>
        </div>
      </div>

      <%# Search Info Row %>
      <div class="dashboard-grid mb-6" style="grid-template-columns: 1fr 1fr 1fr;">
        <%# Criteria Panel %>
        <div class="dashboard-panel">
          <h3 class="dashboard-panel-title mb-3">Search Criteria</h3>
          <div class="criteria-list">
            <% if @saved_search.criteria["state"].present? %>
              <div class="criteria-item">
                <span class="criteria-label">State</span>
                <span class="criteria-value"><%= @saved_search.criteria["state"] %></span>
              </div>
            <% end %>
            <% if @saved_search.criteria["suburbs"].present? %>
              <div class="criteria-item">
                <span class="criteria-label">Suburbs</span>
                <span class="criteria-value"><%= @saved_search.criteria["suburbs"].join(", ") %></span>
              </div>
            <% end %>
            <% if @saved_search.criteria["property_types"].present? %>
              <div class="criteria-item">
                <span class="criteria-label">Types</span>
                <span class="criteria-value"><%= @saved_search.criteria["property_types"].map(&:humanize).join(", ") %></span>
              </div>
            <% end %>
            <% if @saved_search.criteria["min_bedrooms"].present? || @saved_search.criteria["max_bedrooms"].present? %>
              <div class="criteria-item">
                <span class="criteria-label">Bedrooms</span>
                <span class="criteria-value">
                  <%= @saved_search.criteria["min_bedrooms"] || "Any" %> - <%= @saved_search.criteria["max_bedrooms"] || "Any" %>
                </span>
              </div>
            <% end %>
            <% if @saved_search.criteria["min_price_cents"].present? || @saved_search.criteria["max_price_cents"].present? %>
              <div class="criteria-item">
                <span class="criteria-label">Price</span>
                <span class="criteria-value">
                  <%= number_to_currency((@saved_search.criteria["min_price_cents"] || 0) / 100, precision: 0) %> -
                  <%= @saved_search.criteria["max_price_cents"].present? ? number_to_currency(@saved_search.criteria["max_price_cents"] / 100, precision: 0) : "Any" %>
                </span>
              </div>
            <% end %>
          </div>
        </div>

        <%# Alert Settings Panel %>
        <div class="dashboard-panel">
          <h3 class="dashboard-panel-title mb-3">Alert Settings</h3>
          <div class="flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <span>Frequency</span>
              <span class="badge <%= alert_frequency_badge_class(@saved_search.alert_frequency) %>">
                <%= @saved_search.alert_frequency.humanize %>
              </span>
            </div>
            <div class="flex items-center justify-between">
              <span>Email Alerts</span>
              <span class="badge <%= @saved_search.email_alerts? ? 'badge-green' : 'badge-gray' %>">
                <%= @saved_search.email_alerts? ? "On" : "Off" %>
              </span>
            </div>
            <div class="flex items-center justify-between">
              <span>Push Alerts</span>
              <span class="badge <%= @saved_search.push_alerts? ? 'badge-blue' : 'badge-gray' %>">
                <%= @saved_search.push_alerts? ? "On" : "Off" %>
              </span>
            </div>
            <% if @saved_search.last_alerted_at.present? %>
              <p class="text-small text-muted mt-2">Last alerted <%= time_ago_in_words(@saved_search.last_alerted_at) %> ago</p>
            <% end %>
          </div>
        </div>

        <%# Stats Panel %>
        <div class="dashboard-panel">
          <h3 class="dashboard-panel-title mb-3">Results</h3>
          <div class="flex gap-6">
            <div class="text-center">
              <p class="font-bold" style="font-size: 2rem;"><%= @matching_properties.count %></p>
              <p class="text-secondary text-small">Total Matches</p>
            </div>
            <% if @new_count > 0 %>
              <div class="text-center">
                <p class="font-bold text-success" style="font-size: 2rem;"><%= @new_count %></p>
                <p class="text-secondary text-small">New Since Last Alert</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <%# Matching Properties %>
      <div class="dashboard-panel">
        <div class="dashboard-panel-header">
          <div>
            <h2 class="dashboard-panel-title">Matching Properties</h2>
            <p class="dashboard-panel-subtitle"><%= pluralize(@matching_properties.count, "property") %> found</p>
          </div>
        </div>

        <% if @matching_properties.any? %>
          <div class="property-grid">
            <% @matching_properties.each do |property| %>
              <div class="property-card">
                <%# Property Image %>
                <div class="property-card-image">
                  <% if property.hero_image.attached? %>
                    <%= image_tag property.hero_image.variant(resize_to_fill: [400, 300]), alt: property.headline || property.street_address %>
                  <% else %>
                    <div class="property-card-placeholder"></div>
                  <% end %>

                  <%# New Badge %>
                  <% if property.published_at && property.published_at > (@saved_search.last_alerted_at || @saved_search.created_at) %>
                    <span class="property-card-badge badge-success">New</span>
                  <% elsif property.listing_intent == "open_to_offers" %>
                    <span class="property-card-badge badge-blue">Open to Offers</span>
                  <% end %>

                  <%# Love Button %>
                  <% if user_signed_in? %>
                    <% loved = current_user.property_loves.exists?(property: property) %>
                    <% if loved %>
                      <% love = current_user.property_loves.find_by(property: property) %>
                      <%= button_to buyer_saved_property_path(love), method: :delete, class: "property-card-love active" do %>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                          <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                        </svg>
                      <% end %>
                    <% else %>
                      <%= button_to buyer_saved_properties_path(property_id: property.id), method: :post, class: "property-card-love" do %>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                        </svg>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>

                <%# Property Details %>
                <%= link_to property_path(property), class: "property-card-content" do %>
                  <h3 class="property-card-title"><%= property.headline || property.street_address %></h3>
                  <p class="property-card-location">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                      <circle cx="12" cy="10" r="3"/>
                    </svg>
                    <%= property.suburb %>, <%= property.state %>
                  </p>

                  <p class="property-card-price"><%= property.price_range_display %></p>

                  <div class="property-card-features">
                    <% if property.bedrooms.present? %>
                      <span class="property-feature">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/>
                        </svg>
                        <%= property.bedrooms %>
                      </span>
                    <% end %>
                    <% if property.bathrooms.present? %>
                      <span class="property-feature">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M9 6 6.5 3.5a1.5 1.5 0 0 0-1-.5C4.683 3 4 3.683 4 4.5V17a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5"/>
                          <line x1="10" x2="8" y1="5" y2="7"/><line x1="2" x2="22" y1="12" y2="12"/>
                          <line x1="7" x2="7" y1="19" y2="21"/><line x1="17" x2="17" y1="19" y2="21"/>
                        </svg>
                        <%= property.bathrooms %>
                      </span>
                    <% end %>
                    <% if property.parking_spaces.present? && property.parking_spaces > 0 %>
                      <span class="property-feature">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.5 2.8c-.1.2-.1.4-.1.6v4.7c0 .6.4 1 1 1h2"/>
                          <circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/>
                        </svg>
                        <%= property.parking_spaces %>
                      </span>
                    <% end %>
                  </div>

                  <span class="property-card-type badge badge-gray"><%= property.property_type.humanize %></span>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="card-empty">
            <div class="card-empty-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
            </div>
            <div class="card-empty-title">No matching properties</div>
            <div class="card-empty-description">Try adjusting your search criteria to find more properties</div>
            <%= link_to edit_buyer_saved_search_path(@saved_search), class: "btn btn-secondary" do %>
              Edit Search Criteria
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </main>
</div>
