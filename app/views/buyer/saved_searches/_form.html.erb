<%= form_with model: saved_search, url: saved_search.persisted? ? buyer_saved_search_path(saved_search) : buyer_saved_searches_path, class: "saved-search-form" do |f| %>
  <% if saved_search.errors.any? %>
    <div class="alert alert-error mb-6">
      <div class="alert-content">
        <strong><%= pluralize(saved_search.errors.count, "error") %> prevented this search from being saved:</strong>
        <ul class="mt-2">
          <% saved_search.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
    <%# Left Column - Search Criteria %>
    <div class="flex flex-col gap-6">
      <%# Search Name %>
      <div class="dashboard-panel">
        <h3 class="dashboard-panel-title mb-4">Search Name</h3>
        <div class="form-group">
          <%= f.label :name, "Give your search a name", class: "form-label" %>
          <%= f.text_field :name, class: "form-input", placeholder: "e.g., 3 bed houses in Sydney" %>
        </div>
      </div>

      <%# Location %>
      <div class="dashboard-panel">
        <h3 class="dashboard-panel-title mb-4">Location</h3>

        <div class="form-group">
          <%= f.label "criteria[state]", "State", class: "form-label" %>
          <%= f.select "criteria[state]",
                options_for_select(Property::AUSTRALIAN_STATES.map { |s| [s, s] }, saved_search.criteria&.dig("state")),
                { include_blank: "Any state" },
                class: "form-select" %>
        </div>

        <div class="form-group">
          <%= f.label "criteria[suburbs]", "Suburbs", class: "form-label" %>
          <%= f.text_field "criteria[suburbs]",
                value: saved_search.criteria&.dig("suburbs")&.join(", "),
                class: "form-input",
                placeholder: "Enter suburbs separated by commas" %>
          <p class="form-hint">e.g., Bondi, Manly, Surry Hills</p>
        </div>

        <div class="form-group">
          <%= f.label "criteria[postcodes]", "Postcodes", class: "form-label" %>
          <%= f.text_field "criteria[postcodes]",
                value: saved_search.criteria&.dig("postcodes")&.join(", "),
                class: "form-input",
                placeholder: "Enter postcodes separated by commas" %>
          <p class="form-hint">e.g., 2000, 2010, 2026</p>
        </div>
      </div>

      <%# Property Type %>
      <div class="dashboard-panel">
        <h3 class="dashboard-panel-title mb-4">Property Type</h3>
        <div class="checkbox-grid">
          <% Property::PROPERTY_TYPES.each do |type| %>
            <label class="checkbox-card">
              <%= check_box_tag "saved_search[criteria][property_types][]",
                    type,
                    saved_search.criteria&.dig("property_types")&.include?(type),
                    id: "property_type_#{type}" %>
              <span class="checkbox-card-content">
                <span class="checkbox-card-icon">
                  <% case type %>
                  <% when "house" %>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                  <% when "townhouse" %>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>
                  <% when "apartment", "unit" %>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>
                  <% when "land" %>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 22 16 8"/><path d="M3.47 12.53 5 11l1.53 1.53a3.5 3.5 0 0 1 0 4.94L5 19l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z"/><path d="M7.47 8.53 9 7l1.53 1.53a3.5 3.5 0 0 1 0 4.94L9 15l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z"/><path d="M11.47 4.53 13 3l1.53 1.53a3.5 3.5 0 0 1 0 4.94L13 11l-1.53-1.53a3.5 3.5 0 0 1 0-4.94Z"/><path d="M20 2h2v2a4 4 0 0 1-4 4h-2V6a4 4 0 0 1 4-4Z"/><path d="M11.47 17.47 13 19l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L5 19l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z"/><path d="M15.47 13.47 17 15l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L9 15l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z"/><path d="M19.47 9.47 21 11l-1.53 1.53a3.5 3.5 0 0 1-4.94 0L13 11l1.53-1.53a3.5 3.5 0 0 1 4.94 0Z"/></svg>
                  <% else %>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                  <% end %>
                </span>
                <span class="checkbox-card-label"><%= type.humanize %></span>
              </span>
            </label>
          <% end %>
        </div>
      </div>

      <%# Bedrooms & Bathrooms %>
      <div class="dashboard-panel">
        <h3 class="dashboard-panel-title mb-4">Rooms & Features</h3>

        <div class="form-row">
          <div class="form-group">
            <%= f.label "criteria[min_bedrooms]", "Min Bedrooms", class: "form-label" %>
            <%= f.select "criteria[min_bedrooms]",
                  options_for_select([["Any", ""]] + (1..6).map { |n| [n == 6 ? "6+" : n.to_s, n] }, saved_search.criteria&.dig("min_bedrooms")),
                  {},
                  class: "form-select" %>
          </div>

          <div class="form-group">
            <%= f.label "criteria[max_bedrooms]", "Max Bedrooms", class: "form-label" %>
            <%= f.select "criteria[max_bedrooms]",
                  options_for_select([["Any", ""]] + (1..6).map { |n| [n == 6 ? "6+" : n.to_s, n] }, saved_search.criteria&.dig("max_bedrooms")),
                  {},
                  class: "form-select" %>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <%= f.label "criteria[min_bathrooms]", "Min Bathrooms", class: "form-label" %>
            <%= f.select "criteria[min_bathrooms]",
                  options_for_select([["Any", ""]] + (1..4).map { |n| [n.to_s, n] }, saved_search.criteria&.dig("min_bathrooms")),
                  {},
                  class: "form-select" %>
          </div>

          <div class="form-group">
            <%= f.label "criteria[min_parking]", "Min Parking", class: "form-label" %>
            <%= f.select "criteria[min_parking]",
                  options_for_select([["Any", ""]] + (1..4).map { |n| [n.to_s, n] }, saved_search.criteria&.dig("min_parking")),
                  {},
                  class: "form-select" %>
          </div>
        </div>
      </div>

      <%# Price Range %>
      <div class="dashboard-panel">
        <h3 class="dashboard-panel-title mb-4">Price Range</h3>

        <div class="form-row">
          <div class="form-group">
            <%= f.label "criteria[min_price_cents]", "Min Price", class: "form-label" %>
            <%= f.select "criteria[min_price_cents]",
                  options_for_select(
                    [["Any", ""]] + [
                      ["$100,000", 10000000],
                      ["$200,000", 20000000],
                      ["$300,000", 30000000],
                      ["$400,000", 40000000],
                      ["$500,000", 50000000],
                      ["$600,000", 60000000],
                      ["$700,000", 70000000],
                      ["$800,000", 80000000],
                      ["$900,000", 90000000],
                      ["$1,000,000", 100000000],
                      ["$1,250,000", 125000000],
                      ["$1,500,000", 150000000],
                      ["$2,000,000", 200000000],
                      ["$3,000,000", 300000000],
                      ["$5,000,000", 500000000]
                    ],
                    saved_search.criteria&.dig("min_price_cents")
                  ),
                  {},
                  class: "form-select" %>
          </div>

          <div class="form-group">
            <%= f.label "criteria[max_price_cents]", "Max Price", class: "form-label" %>
            <%= f.select "criteria[max_price_cents]",
                  options_for_select(
                    [["Any", ""]] + [
                      ["$200,000", 20000000],
                      ["$300,000", 30000000],
                      ["$400,000", 40000000],
                      ["$500,000", 50000000],
                      ["$600,000", 60000000],
                      ["$700,000", 70000000],
                      ["$800,000", 80000000],
                      ["$900,000", 90000000],
                      ["$1,000,000", 100000000],
                      ["$1,250,000", 125000000],
                      ["$1,500,000", 150000000],
                      ["$2,000,000", 200000000],
                      ["$3,000,000", 300000000],
                      ["$5,000,000", 500000000],
                      ["$10,000,000+", 1000000000]
                    ],
                    saved_search.criteria&.dig("max_price_cents")
                  ),
                  {},
                  class: "form-select" %>
          </div>
        </div>
      </div>
    </div>

    <%# Right Column - Alert Settings %>
    <div class="flex flex-col gap-6">
      <div class="dashboard-panel" style="position: sticky; top: 100px;">
        <h3 class="dashboard-panel-title mb-4">Alert Settings</h3>

        <div class="form-group">
          <%= f.label :alert_frequency, "Alert Frequency", class: "form-label" %>
          <div class="radio-group">
            <% SavedSearch::ALERT_FREQUENCIES.each do |freq| %>
              <label class="radio-card">
                <%= f.radio_button :alert_frequency, freq, class: "radio-input" %>
                <span class="radio-card-content">
                  <span class="radio-card-label"><%= freq.humanize %></span>
                  <span class="radio-card-description">
                    <% case freq %>
                    <% when "instant" %>Get notified immediately when new properties match
                    <% when "daily" %>Receive a daily digest of new matches
                    <% when "weekly" %>Receive a weekly summary of new matches
                    <% end %>
                  </span>
                </span>
              </label>
            <% end %>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Notification Channels</label>
          <div class="flex flex-col gap-3">
            <label class="toggle-switch">
              <%= f.check_box :email_alerts, class: "toggle-input" %>
              <span class="toggle-slider"></span>
              <span class="toggle-label">
                <span class="toggle-label-text">Email Alerts</span>
                <span class="toggle-label-description">Receive alerts via email</span>
              </span>
            </label>

            <label class="toggle-switch">
              <%= f.check_box :push_alerts, class: "toggle-input" %>
              <span class="toggle-slider"></span>
              <span class="toggle-label">
                <span class="toggle-label-text">Push Notifications</span>
                <span class="toggle-label-description">Receive alerts on your device</span>
              </span>
            </label>
          </div>
        </div>

        <hr class="my-4">

        <div class="flex flex-col gap-3">
          <%= f.submit saved_search.persisted? ? "Update Search" : "Save Search", class: "btn btn-primary btn-block" %>
          <%= link_to "Cancel", saved_search.persisted? ? buyer_saved_search_path(saved_search) : buyer_saved_searches_path, class: "btn btn-ghost btn-block" %>
        </div>
      </div>
    </div>
  </div>
<% end %>
