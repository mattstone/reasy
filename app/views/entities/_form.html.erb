<%# Entity Type Selection (only for new entities) %>
<% unless entity.persisted? %>
  <div class="dashboard-panel mb-6">
    <div class="dashboard-panel-header">
      <div>
        <h2 class="dashboard-panel-title">Entity Type</h2>
        <p class="dashboard-panel-subtitle">Select the type of entity you want to create</p>
      </div>
    </div>

    <div class="grid grid-cols-3 gap-4" data-controller="entity-type">
      <%# Individual %>
      <label class="entity-type-card" data-entity-type-target="card" data-type="individual">
        <%= f.radio_button :entity_type, "individual",
              class: "hidden",
              data: { entity_type_target: "radio", action: "change->entity-type#toggle" } %>
        <div class="entity-type-card-inner p-4" style="background: var(--color-gray-50); border-radius: var(--radius-lg); border: 2px solid transparent; cursor: pointer; transition: all var(--transition-fast);">
          <div class="metric-card-icon metric-card-icon-blue mb-3" style="width: 48px; height: 48px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </div>
          <div class="font-semibold mb-1">Individual</div>
          <div class="text-small text-muted">A person buying or selling property in their own name</div>
        </div>
      </label>

      <%# Company %>
      <label class="entity-type-card" data-entity-type-target="card" data-type="company">
        <%= f.radio_button :entity_type, "company",
              class: "hidden",
              data: { entity_type_target: "radio", action: "change->entity-type#toggle" } %>
        <div class="entity-type-card-inner p-4" style="background: var(--color-gray-50); border-radius: var(--radius-lg); border: 2px solid transparent; cursor: pointer; transition: all var(--transition-fast);">
          <div class="metric-card-icon metric-card-icon-purple mb-3" style="width: 48px; height: 48px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/>
              <path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/>
              <path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/>
              <path d="M10 6h4"/>
              <path d="M10 10h4"/>
              <path d="M10 14h4"/>
              <path d="M10 18h4"/>
            </svg>
          </div>
          <div class="font-semibold mb-1">Company</div>
          <div class="text-small text-muted">A registered company or business entity</div>
        </div>
      </label>

      <%# SMSF %>
      <label class="entity-type-card" data-entity-type-target="card" data-type="smsf">
        <%= f.radio_button :entity_type, "smsf",
              class: "hidden",
              data: { entity_type_target: "radio", action: "change->entity-type#toggle" } %>
        <div class="entity-type-card-inner p-4" style="background: var(--color-gray-50); border-radius: var(--radius-lg); border: 2px solid transparent; cursor: pointer; transition: all var(--transition-fast);">
          <div class="metric-card-icon metric-card-icon-teal mb-3" style="width: 48px; height: 48px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 9 12 5 2 9l10 4 10-4Z"/>
              <path d="M6 10.6V16a6 3 0 0 0 12 0v-5.4"/>
              <path d="M22 9v5"/>
            </svg>
          </div>
          <div class="font-semibold mb-1">SMSF</div>
          <div class="text-small text-muted">A self-managed superannuation fund</div>
        </div>
      </label>
    </div>
  </div>

  <style>
    .entity-type-card input:checked + .entity-type-card-inner {
      border-color: var(--color-primary);
      background: var(--color-primary-pale);
    }
  </style>
<% else %>
  <%# Show entity type as read-only for existing entities %>
  <div class="dashboard-panel mb-6">
    <div class="dashboard-panel-header">
      <div>
        <h2 class="dashboard-panel-title">Entity Type</h2>
        <p class="dashboard-panel-subtitle">Entity type cannot be changed after creation</p>
      </div>
    </div>

    <div class="flex items-center gap-3 p-4" style="background: var(--color-gray-50); border-radius: var(--radius-lg);">
      <% case entity.entity_type %>
      <% when "individual" %>
        <div class="metric-card-icon metric-card-icon-blue" style="width: 44px; height: 44px;">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </div>
      <% when "company" %>
        <div class="metric-card-icon metric-card-icon-purple" style="width: 44px; height: 44px;">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/>
            <path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/>
            <path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/>
          </svg>
        </div>
      <% when "smsf" %>
        <div class="metric-card-icon metric-card-icon-teal" style="width: 44px; height: 44px;">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 9 12 5 2 9l10 4 10-4Z"/>
            <path d="M6 10.6V16a6 3 0 0 0 12 0v-5.4"/>
            <path d="M22 9v5"/>
          </svg>
        </div>
      <% end %>
      <div>
        <div class="font-semibold"><%= entity.entity_type.humanize.titleize %></div>
        <div class="text-small text-muted">This cannot be changed</div>
      </div>
    </div>
    <%= f.hidden_field :entity_type %>
  </div>
<% end %>

<%# Individual Fields %>
<div class="dashboard-panel mb-6 entity-fields" data-entity-type="individual" style="<%= 'display: none;' unless entity.entity_type == 'individual' || entity.entity_type.blank? %>">
  <div class="dashboard-panel-header">
    <div>
      <h2 class="dashboard-panel-title">Personal Details</h2>
      <p class="dashboard-panel-subtitle">Information about the individual</p>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :name, "Full Name", class: "form-label form-label-required" %>
    <%= f.text_field :name, class: "form-input", placeholder: "e.g. John Smith" %>
  </div>

  <div class="form-row">
    <div class="form-group">
      <%= f.label :date_of_birth, "Date of Birth", class: "form-label form-label-required" %>
      <%= f.date_field :date_of_birth, class: "form-input", max: Date.current %>
    </div>

    <div class="form-group">
      <%= f.label :tfn, "Tax File Number (TFN)", class: "form-label" %>
      <%= f.text_field :tfn, class: "form-input", placeholder: "Optional - encrypted" %>
      <p class="form-help">Your TFN is securely encrypted and only used when required</p>
    </div>
  </div>
</div>

<%# Company Fields %>
<div class="dashboard-panel mb-6 entity-fields" data-entity-type="company" style="<%= 'display: none;' unless entity.entity_type == 'company' %>">
  <div class="dashboard-panel-header">
    <div>
      <h2 class="dashboard-panel-title">Company Details</h2>
      <p class="dashboard-panel-subtitle">Registered company information</p>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :name, "Company Name", class: "form-label form-label-required" %>
    <%= f.text_field :name, class: "form-input", placeholder: "e.g. Smith Holdings Pty Ltd" %>
  </div>

  <div class="form-row">
    <div class="form-group">
      <%= f.label :abn, "ABN", class: "form-label form-label-required" %>
      <%= f.text_field :abn, class: "form-input", placeholder: "11 digit ABN", maxlength: 11 %>
      <p class="form-help">Australian Business Number (11 digits)</p>
    </div>

    <div class="form-group">
      <%= f.label :acn, "ACN", class: "form-label" %>
      <%= f.text_field :acn, class: "form-input", placeholder: "9 digit ACN", maxlength: 9 %>
      <p class="form-help">Australian Company Number (optional)</p>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :tfn, "Company TFN", class: "form-label" %>
    <%= f.text_field :tfn, class: "form-input", placeholder: "Optional - encrypted" %>
    <p class="form-help">Company Tax File Number - securely encrypted</p>
  </div>
</div>

<%# SMSF Fields %>
<div class="dashboard-panel mb-6 entity-fields" data-entity-type="smsf" style="<%= 'display: none;' unless entity.entity_type == 'smsf' %>">
  <div class="dashboard-panel-header">
    <div>
      <h2 class="dashboard-panel-title">SMSF Details</h2>
      <p class="dashboard-panel-subtitle">Self-managed superannuation fund information</p>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :fund_name, "Fund Name", class: "form-label form-label-required" %>
    <%= f.text_field :fund_name, class: "form-input", placeholder: "e.g. Smith Family Super Fund" %>
  </div>

  <div class="form-row">
    <div class="form-group">
      <%= f.label :fund_abn, "Fund ABN", class: "form-label form-label-required" %>
      <%= f.text_field :fund_abn, class: "form-input", placeholder: "11 digit ABN", maxlength: 11 %>
      <p class="form-help">The ABN registered for the SMSF</p>
    </div>

    <div class="form-group">
      <%= f.label :name, "Fund Reference Name", class: "form-label form-label-required" %>
      <%= f.text_field :name, class: "form-input", placeholder: "e.g. Smith SMSF" %>
      <p class="form-help">A name to identify this fund in the system</p>
    </div>
  </div>

  <div class="divider"></div>

  <h3 class="dashboard-panel-title mb-4">Trustee Details</h3>

  <div class="form-row">
    <div class="form-group">
      <%= f.label :trustee_name, "Trustee Name", class: "form-label" %>
      <%= f.text_field :trustee_name, class: "form-input", placeholder: "Name of the trustee" %>
    </div>

    <div class="form-group">
      <%= f.label :trustee_type, "Trustee Type", class: "form-label" %>
      <%= f.select :trustee_type,
            options_for_select([
              ["Individual Trustee", "individual"],
              ["Corporate Trustee", "corporate"]
            ], entity.trustee_type),
            { include_blank: "Select trustee type..." },
            class: "form-select" %>
    </div>
  </div>
</div>

<%# Address Section %>
<div class="dashboard-panel mb-6">
  <div class="dashboard-panel-header">
    <div>
      <h2 class="dashboard-panel-title">Address</h2>
      <p class="dashboard-panel-subtitle">Registered address for this entity</p>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :address_line_1, "Address Line 1", class: "form-label" %>
    <%= f.text_field :address_line_1, class: "form-input", placeholder: "Street address" %>
  </div>

  <div class="form-group">
    <%= f.label :address_line_2, "Address Line 2", class: "form-label" %>
    <%= f.text_field :address_line_2, class: "form-input", placeholder: "Apartment, suite, unit, etc. (optional)" %>
  </div>

  <div class="form-row">
    <div class="form-group">
      <%= f.label :suburb, "Suburb", class: "form-label" %>
      <%= f.text_field :suburb, class: "form-input", placeholder: "e.g. Sydney" %>
    </div>

    <div class="form-group">
      <%= f.label :state, "State", class: "form-label" %>
      <%= f.select :state,
            options_for_select([
              ["New South Wales", "NSW"],
              ["Victoria", "VIC"],
              ["Queensland", "QLD"],
              ["Western Australia", "WA"],
              ["South Australia", "SA"],
              ["Tasmania", "TAS"],
              ["Australian Capital Territory", "ACT"],
              ["Northern Territory", "NT"]
            ], entity.state),
            { include_blank: "Select state..." },
            class: "form-select" %>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <%= f.label :postcode, "Postcode", class: "form-label" %>
      <%= f.text_field :postcode, class: "form-input", placeholder: "e.g. 2000", maxlength: 4 %>
    </div>

    <div class="form-group">
      <%= f.label :country, "Country", class: "form-label" %>
      <%= f.text_field :country, class: "form-input", value: entity.country || "Australia", placeholder: "Australia" %>
    </div>
  </div>
</div>

<%# Default Entity Section %>
<div class="dashboard-panel mb-6">
  <div class="dashboard-panel-header">
    <div>
      <h2 class="dashboard-panel-title">Default Entity</h2>
      <p class="dashboard-panel-subtitle">Set this entity as your default for new transactions</p>
    </div>
  </div>

  <div class="form-group">
    <div class="form-check p-4" style="background: var(--color-gray-50); border-radius: var(--radius-lg);">
      <%= f.check_box :is_default, class: "form-check-input", id: "entity_is_default" %>
      <label for="entity_is_default" class="form-check-label" style="cursor: pointer;">
        <span class="font-semibold flex items-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
          Set as default entity
        </span>
        <span class="text-small text-muted block mt-1">This entity will be pre-selected when creating new property listings or making offers</span>
      </label>
    </div>
  </div>
</div>

<%# JavaScript for entity type toggling %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const typeRadios = document.querySelectorAll('input[name="entity[entity_type]"]');
    const fieldSections = document.querySelectorAll('.entity-fields');

    function updateVisibleFields() {
      const selectedType = document.querySelector('input[name="entity[entity_type]"]:checked');
      if (!selectedType) return;

      fieldSections.forEach(section => {
        if (section.dataset.entityType === selectedType.value) {
          section.style.display = '';
        } else {
          section.style.display = 'none';
        }
      });
    }

    typeRadios.forEach(radio => {
      radio.addEventListener('change', updateVisibleFields);
    });

    // Initial state
    updateVisibleFields();
  });
</script>
