<%#
  AI Analysis Section - "What Stevie/Evie Thinks"
  Shows personalized AI analysis for a property

  Local variables:
  - property: Property - the property being analyzed
  - user: User (optional) - current user for personalized analysis
  - analysis: PropertyAnalysis (optional) - cached analysis if available
  - show_cta: Boolean (default true) - whether to show "Ask about this property" button
%>
<%
  user ||= current_user if defined?(current_user)
  analysis ||= user ? PropertyAnalysis.find_valid(property: property, user: user) : nil
  show_cta = local_assigns.fetch(:show_cta, true)

  # Use cached analysis if available, otherwise build live context
  if analysis&.valid?
    agent_name = analysis.agent_name
    match_score = analysis.match_score
    match_quality = analysis.match_quality_label
    strengths = analysis.formatted_strengths
    considerations = analysis.formatted_considerations
    suggestion = analysis.suggestion
    badges = analysis.formatted_badges
  elsif user
    context = AI::PropertyContextBuilder.new(property, user)
    agent_name = user.preferred_agent_name || "Stevie"
    match_score = context.send(:match_score)
    match_quality = case match_score
                    when 80..100 then "Excellent Match"
                    when 65..79 then "Good Match"
                    when 50..64 then "Moderate Match"
                    when 30..49 then "Low Match"
                    else "Unknown"
                    end if match_score
    strengths = context.send(:strengths_for_user)
    considerations = context.send(:considerations_for_user)
    suggestion = nil
    badges = context.badges

    # Queue analysis generation in background if user is logged in
    if user && !PropertyAnalysis.for_property(property).for_user(user).where(status: %w[pending processing]).exists?
      GeneratePropertyAnalysisJob.perform_later(property.id, user.id)
    end
  else
    # No user - show generic insights
    agent_name = "Stevie"
    match_score = nil
    match_quality = nil
    strengths = []
    considerations = []
    suggestion = nil
    context = AI::PropertyContextBuilder.new(property, nil)
    badges = context.badges
  end
%>

<div class="ai-analysis-section" data-controller="ai-analysis" data-property-id="<%= property.id %>">
  <div class="ai-analysis-header">
    <div class="ai-analysis-avatar">
      <div class="ai-avatar-circle ai-avatar-<%= agent_name.downcase %>">
        <%= agent_name[0] %>
      </div>
    </div>
    <div class="ai-analysis-title">
      <h3>What <%= agent_name %> Thinks</h3>
      <% if match_score && match_quality %>
        <div class="ai-match-indicator ai-match-<%= match_quality.parameterize %>">
          <span class="ai-match-score"><%= match_score %>%</span>
          <span class="ai-match-label"><%= match_quality %></span>
        </div>
      <% end %>
    </div>
  </div>

  <div class="ai-analysis-content">
    <% if strengths.any? %>
      <div class="ai-analysis-group ai-analysis-strengths">
        <h4>Strengths for you</h4>
        <ul>
          <% strengths.each do |strength| %>
            <li><%= strength %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <% if considerations.any? %>
      <div class="ai-analysis-group ai-analysis-considerations">
        <h4>Things to consider</h4>
        <ul>
          <% considerations.each do |consideration| %>
            <li><%= consideration %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <% if suggestion.present? %>
      <div class="ai-analysis-group ai-analysis-suggestion">
        <h4><%= agent_name %>'s suggestion</h4>
        <p><%= suggestion %></p>
      </div>
    <% end %>

    <% if !user %>
      <div class="ai-analysis-cta-login">
        <p>Sign in to get a personalized analysis based on your preferences and budget.</p>
        <%= link_to "Sign in", new_user_session_path, class: "btn btn-secondary btn-sm" %>
      </div>
    <% elsif strengths.empty? && considerations.empty? %>
      <div class="ai-analysis-generating">
        <div class="ai-loading-indicator">
          <span class="ai-loading-dot"></span>
          <span class="ai-loading-dot"></span>
          <span class="ai-loading-dot"></span>
        </div>
        <p><%= agent_name %> is analyzing this property for you...</p>
      </div>
    <% end %>
  </div>

  <% if show_cta && user %>
    <div class="ai-analysis-footer">
      <%= link_to ai_conversations_path(context_type: "property", context_id: property.id),
                  class: "ai-analysis-chat-btn",
                  data: { turbo_method: :post } do %>
        <span class="ai-chat-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </span>
        Ask <%= agent_name %> about this property
      <% end %>
    </div>
  <% end %>
</div>
