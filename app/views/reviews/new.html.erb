<div class="layout">
  <%= render "shared/dashboard_sidebar" %>

  <main class="layout-main">
    <div class="content">
      <%# Back Link %>
      <div class="mb-4">
        <%= link_to reviews_path, class: "btn btn-ghost btn-sm" do %>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          Back to Reviews
        <% end %>
      </div>

      <%# Page Header %>
      <div class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Write a Review</h1>
          <p class="page-subtitle">Share your experience with <%= @reviewee.name %></p>
        </div>
      </div>

      <%# Reviewee Info %>
      <div class="dashboard-panel mb-6">
        <div class="review-reviewee-info">
          <% if @reviewee.avatar&.attached? %>
            <%= image_tag @reviewee.avatar, class: "avatar avatar-lg" %>
          <% else %>
            <div class="avatar avatar-lg avatar-placeholder">
              <%= @reviewee.name.first.upcase %>
            </div>
          <% end %>
          <div>
            <h3><%= @reviewee.name %></h3>
            <span class="badge badge-gray"><%= @review.reviewee_role.humanize %></span>
          </div>
        </div>
      </div>

      <%# Review Form %>
      <div class="dashboard-panel">
        <%= form_with model: @review, class: "review-form" do |f| %>
          <%= f.hidden_field :reviewee_id %>
          <%= f.hidden_field :reviewee_role %>

          <% if @review.errors.any? %>
            <div class="alert alert-error mb-6">
              <ul>
                <% @review.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <%# Overall Rating %>
          <div class="form-section">
            <h3 class="form-section-title">Overall Rating</h3>
            <div class="rating-input" data-controller="rating">
              <% 5.times do |i| %>
                <label class="rating-star">
                  <%= f.radio_button :overall_rating, i + 1, data: { rating_target: "input" } %>
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-rating-target="star" data-value="<%= i + 1 %>">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                  </svg>
                </label>
              <% end %>
              <span class="rating-label" data-rating-target="label">Select a rating</span>
            </div>
          </div>

          <%# Category Ratings %>
          <% if @review.available_categories.any? %>
            <div class="form-section">
              <h3 class="form-section-title">Category Ratings</h3>
              <p class="form-section-description">Rate specific aspects of your experience</p>

              <div class="category-ratings-grid">
                <% @review.available_categories.each do |category| %>
                  <div class="category-rating-input">
                    <label class="category-rating-label"><%= category.humanize %></label>
                    <div class="category-rating-stars" data-controller="rating">
                      <% 5.times do |i| %>
                        <label class="rating-star rating-star-sm">
                          <%= f.radio_button "category_ratings[#{category}]", i + 1, data: { rating_target: "input" } %>
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-rating-target="star" data-value="<%= i + 1 %>">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                          </svg>
                        </label>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <%# Title (Optional) %>
          <div class="form-section">
            <div class="form-group">
              <%= f.label :title, "Review Title (Optional)", class: "form-label" %>
              <%= f.text_field :title, class: "form-control", placeholder: "Summarize your experience in a few words", maxlength: 100 %>
            </div>
          </div>

          <%# Body %>
          <div class="form-section">
            <div class="form-group">
              <%= f.label :body, "Your Review", class: "form-label" %>
              <%= f.text_area :body, class: "form-control", rows: 6, placeholder: "Share the details of your experience. What went well? What could have been better?", minlength: 10, maxlength: 2000, required: true %>
              <p class="form-hint">Minimum 10 characters, maximum 2000 characters</p>
            </div>
          </div>

          <%# Negative Review Warning %>
          <div class="review-warning" data-controller="review-warning">
            <div class="alert alert-warning">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              <div>
                <strong>Note about negative reviews</strong>
                <p>Reviews with 2 stars or less are held for 48 hours before publication. This gives the reviewee time to respond or dispute if necessary.</p>
              </div>
            </div>
          </div>

          <%# Submit %>
          <div class="form-actions">
            <%= link_to "Cancel", reviews_path, class: "btn btn-secondary" %>
            <%= f.submit "Submit Review", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </main>
</div>
