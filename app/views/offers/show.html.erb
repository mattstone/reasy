<div class="layout">
  <%= render "shared/dashboard_sidebar" %>

  <main class="layout-main">
    <div class="content">
      <%# Page Header %>
      <div class="page-header">
        <div class="page-header-content">
          <div class="flex items-center gap-2 mb-2">
            <%= link_to property_path(@property), class: "text-muted" do %>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m15 18-6-6 6-6"/>
              </svg>
            <% end %>
            <span class="text-small text-muted">Back to Property</span>
          </div>
          <h1 class="page-title">Offer Details</h1>
          <p class="page-subtitle">Your offer on <%= @property.short_address %></p>
        </div>
        <div class="page-header-actions">
          <% case @offer.status %>
          <% when "submitted", "viewed" %>
            <% if @offer.buyer_id == current_user.id %>
              <%= button_to withdraw_offer_path(@offer), method: :post, class: "btn btn-secondary", data: { turbo_confirm: "Are you sure you want to withdraw this offer?" } do %>
                Withdraw Offer
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-6">
        <%# Main Content - 2 columns %>
        <div class="col-span-2">
          <%# Status Banner %>
          <div class="dashboard-panel mb-6" style="
            <% case @offer.status %>
            <% when 'accepted' %>
              background: var(--color-success-pale); border: 1px solid var(--color-success);
            <% when 'rejected' %>
              background: var(--color-error-pale); border: 1px solid var(--color-error);
            <% when 'countered' %>
              background: var(--color-warning-pale); border: 1px solid var(--color-warning);
            <% when 'withdrawn', 'expired' %>
              background: var(--color-gray-100); border: 1px solid var(--color-gray-300);
            <% else %>
              background: var(--color-primary-pale); border: 1px solid var(--color-primary);
            <% end %>
          ">
            <div class="flex items-center gap-4 p-4">
              <% case @offer.status %>
              <% when "submitted" %>
                <div class="metric-card-icon metric-card-icon-blue" style="width: 48px; height: 48px;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2 11 13"/>
                    <path d="m22 2-7 20-4-9-9-4 20-7z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-lg">Offer Submitted</h3>
                  <p class="text-muted">Waiting for the seller to respond</p>
                </div>
              <% when "viewed" %>
                <div class="metric-card-icon metric-card-icon-blue" style="width: 48px; height: 48px;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-lg">Offer Viewed</h3>
                  <p class="text-muted">The seller has seen your offer</p>
                </div>
              <% when "accepted" %>
                <div class="metric-card-icon metric-card-icon-green" style="width: 48px; height: 48px;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-lg" style="color: var(--color-success);">Offer Accepted!</h3>
                  <p class="text-muted">Congratulations! Your offer has been accepted.</p>
                </div>
              <% when "rejected" %>
                <div class="metric-card-icon metric-card-icon-red" style="width: 48px; height: 48px;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="m15 9-6 6"/>
                    <path d="m9 9 6 6"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-lg" style="color: var(--color-error);">Offer Rejected</h3>
                  <p class="text-muted">Unfortunately, the seller has declined your offer.</p>
                </div>
              <% when "countered" %>
                <div class="metric-card-icon metric-card-icon-yellow" style="width: 48px; height: 48px;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-lg" style="color: var(--color-warning);">Counter Offer Received</h3>
                  <p class="text-muted">The seller has made a counter offer</p>
                </div>
              <% when "withdrawn" %>
                <div class="metric-card-icon" style="width: 48px; height: 48px; background: var(--color-gray-200);">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" x2="9" y1="12" y2="12"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-lg">Offer Withdrawn</h3>
                  <p class="text-muted">You withdrew this offer</p>
                </div>
              <% when "expired" %>
                <div class="metric-card-icon" style="width: 48px; height: 48px; background: var(--color-gray-200);">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-lg">Offer Expired</h3>
                  <p class="text-muted">This offer expired without a response</p>
                </div>
              <% end %>
            </div>
          </div>

          <%# Offer Summary %>
          <div class="dashboard-panel mb-6">
            <div class="dashboard-panel-header">
              <div>
                <h2 class="dashboard-panel-title">Offer Summary</h2>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
              <div>
                <div class="stats-summary">
                  <div class="stats-row">
                    <span class="stats-label">Offer Amount</span>
                    <span class="stats-value font-bold" style="color: var(--color-primary); font-size: var(--font-size-xl);">
                      $<%= number_with_delimiter(@offer.amount_cents / 100) %>
                    </span>
                  </div>
                  <% if @offer.deposit_cents.present? %>
                    <div class="stats-row">
                      <span class="stats-label">Deposit</span>
                      <span class="stats-value">$<%= number_with_delimiter(@offer.deposit_cents / 100) %></span>
                    </div>
                  <% end %>
                  <div class="stats-row">
                    <span class="stats-label">Settlement</span>
                    <span class="stats-value"><%= @offer.settlement_days %> days</span>
                  </div>
                  <div class="stats-row">
                    <span class="stats-label">Finance Type</span>
                    <span class="stats-value"><%= @offer.finance_type.humanize.titleize %></span>
                  </div>
                </div>
              </div>

              <div>
                <div class="stats-summary">
                  <div class="stats-row">
                    <span class="stats-label">Submitted</span>
                    <span class="stats-value"><%= @offer.submitted_at&.strftime("%d %b %Y, %I:%M %p") || "-" %></span>
                  </div>
                  <div class="stats-row">
                    <span class="stats-label">Expires</span>
                    <span class="stats-value">
                      <% if @offer.expires_at.present? && @offer.expires_at > Time.current %>
                        <%= @offer.expires_at.strftime("%d %b %Y, %I:%M %p") %>
                        <span class="text-small text-muted">(<%= distance_of_time_in_words_to_now(@offer.expires_at) %> left)</span>
                      <% elsif @offer.expires_at.present? %>
                        <span class="text-muted">Expired</span>
                      <% else %>
                        -
                      <% end %>
                    </span>
                  </div>
                  <% if @offer.buyer_entity.present? %>
                    <div class="stats-row">
                      <span class="stats-label">Buying As</span>
                      <span class="stats-value"><%= @offer.buyer_entity.display_name %></span>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>

            <% if @offer.has_conditions? %>
              <div class="divider my-4"></div>
              <h3 class="font-semibold mb-3">Conditions</h3>
              <div class="flex flex-wrap gap-2">
                <% @offer.conditions_list.each do |condition| %>
                  <span class="badge badge-warning"><%= condition %></span>
                <% end %>
              </div>
            <% end %>

            <% if @offer.message.present? %>
              <div class="divider my-4"></div>
              <h3 class="font-semibold mb-3">Message to Seller</h3>
              <p class="text-muted" style="white-space: pre-line;"><%= @offer.message %></p>
            <% end %>

            <% if @offer.seller_response.present? %>
              <div class="divider my-4"></div>
              <h3 class="font-semibold mb-3">Seller's Response</h3>
              <p class="text-muted" style="white-space: pre-line;"><%= @offer.seller_response %></p>
            <% end %>
          </div>

          <%# Timeline %>
          <div class="dashboard-panel">
            <div class="dashboard-panel-header">
              <div>
                <h2 class="dashboard-panel-title">Timeline</h2>
              </div>
            </div>

            <div class="space-y-4">
              <% if @offer.submitted_at.present? %>
                <div class="flex items-center gap-3">
                  <div class="flex-shrink-0 w-2 h-2 rounded-full" style="background: var(--color-primary);"></div>
                  <div class="flex-1">
                    <div class="text-small font-medium">Offer Submitted</div>
                    <div class="text-small text-muted"><%= @offer.submitted_at.strftime("%d %b %Y at %I:%M %p") %></div>
                  </div>
                </div>
              <% end %>

              <% if @offer.viewed_at.present? %>
                <div class="flex items-center gap-3">
                  <div class="flex-shrink-0 w-2 h-2 rounded-full" style="background: var(--color-primary);"></div>
                  <div class="flex-1">
                    <div class="text-small font-medium">Viewed by Seller</div>
                    <div class="text-small text-muted"><%= @offer.viewed_at.strftime("%d %b %Y at %I:%M %p") %></div>
                  </div>
                </div>
              <% end %>

              <% if @offer.responded_at.present? %>
                <div class="flex items-center gap-3">
                  <div class="flex-shrink-0 w-2 h-2 rounded-full" style="
                    <% case @offer.status %>
                    <% when 'accepted' %>
                      background: var(--color-success);
                    <% when 'rejected' %>
                      background: var(--color-error);
                    <% when 'countered' %>
                      background: var(--color-warning);
                    <% else %>
                      background: var(--color-gray-400);
                    <% end %>
                  "></div>
                  <div class="flex-1">
                    <div class="text-small font-medium">
                      <% case @offer.status %>
                      <% when 'accepted' %>
                        Offer Accepted
                      <% when 'rejected' %>
                        Offer Rejected
                      <% when 'countered' %>
                        Counter Offer Made
                      <% end %>
                    </div>
                    <div class="text-small text-muted"><%= @offer.responded_at.strftime("%d %b %Y at %I:%M %p") %></div>
                  </div>
                </div>
              <% end %>

              <% if @offer.withdrawn_at.present? %>
                <div class="flex items-center gap-3">
                  <div class="flex-shrink-0 w-2 h-2 rounded-full" style="background: var(--color-gray-400);"></div>
                  <div class="flex-1">
                    <div class="text-small font-medium">Offer Withdrawn</div>
                    <div class="text-small text-muted"><%= @offer.withdrawn_at.strftime("%d %b %Y at %I:%M %p") %></div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <%# Sidebar - Property Card %>
        <div>
          <div class="dashboard-panel sticky" style="top: var(--space-6);">
            <%# Property Image %>
            <div style="height: 180px; background: var(--color-gray-100); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: var(--space-4);">
              <% if @property.hero_image.attached? %>
                <%= image_tag @property.hero_image, style: "width: 100%; height: 100%; object-fit: cover;" %>
              <% elsif @property.photos.attached? %>
                <%= image_tag @property.photos.first, style: "width: 100%; height: 100%; object-fit: cover;" %>
              <% else %>
                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--color-gray-400);">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                  </svg>
                </div>
              <% end %>
            </div>

            <%# Property Details %>
            <div class="mb-4">
              <div class="text-lg font-bold mb-1" style="color: var(--color-primary);">
                <%= @property.price_range_display %>
              </div>
              <h3 class="font-semibold"><%= @property.headline.presence || @property.short_address %></h3>
              <p class="text-small text-muted"><%= @property.location %></p>
            </div>

            <% if @property.bedrooms || @property.bathrooms || @property.parking_spaces %>
              <div class="flex items-center gap-3 text-small text-muted mb-4">
                <% if @property.bedrooms %>
                  <span><%= @property.bedrooms %> bed</span>
                <% end %>
                <% if @property.bathrooms %>
                  <span><%= @property.bathrooms %> bath</span>
                <% end %>
                <% if @property.parking_spaces %>
                  <span><%= @property.parking_spaces %> park</span>
                <% end %>
              </div>
            <% end %>

            <%= link_to property_path(@property), class: "btn btn-secondary w-full" do %>
              View Property
            <% end %>

            <% if @offer.accepted? %>
              <div class="divider my-4"></div>
              <div class="text-center">
                <h3 class="font-semibold mb-2">What's Next?</h3>
                <p class="text-small text-muted mb-4">
                  Your conveyancer will contact you to begin the contract process.
                </p>
                <%= link_to "#", class: "btn btn-primary w-full" do %>
                  View Transaction
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
