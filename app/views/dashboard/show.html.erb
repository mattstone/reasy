<div class="layout">
  <%= render "shared/dashboard_sidebar" %>

  <main class="layout-main">
    <div class="content">
      <%# Page Header %>
      <div class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Welcome back, <%= current_user.name&.split&.first || "there" %></h1>
          <p class="page-subtitle">Here's what's happening with your real estate journey</p>
        </div>
        <div class="page-header-actions">
          <% if current_user.seller? %>
            <%= link_to new_seller_property_path, class: "btn btn-primary" do %>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              List a Property
            <% end %>
          <% end %>
          <% if current_user.buyer? %>
            <%= link_to properties_path, class: "btn btn-secondary" do %>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
              </svg>
              Search Properties
            <% end %>
          <% end %>
        </div>
      </div>

      <%# Onboarding Alert %>
      <% if current_user.roles.empty? %>
        <div class="alert alert-info mb-6">
          <div class="alert-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
            </svg>
          </div>
          <div class="alert-content">
            <div class="alert-title">Complete your profile</div>
            <div class="alert-description">Tell us whether you're looking to buy, sell, or both to personalize your experience.</div>
            <div class="alert-actions">
              <%= link_to "Complete profile", onboarding_path, class: "btn btn-sm btn-primary" %>
            </div>
          </div>
        </div>
      <% end %>

      <%# Trial Warning %>
      <% if current_user.trial? && current_user.trial_ends_at.present? && current_user.trial_ends_at < 12.hours.from_now %>
        <div class="alert alert-warning mb-6">
          <div class="alert-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
          </div>
          <div class="alert-content">
            <div class="alert-title">Your trial is ending soon</div>
            <div class="alert-description">Upgrade now to keep access to all features. Your trial ends in <%= time_ago_in_words(current_user.trial_ends_at) %>.</div>
            <div class="alert-actions">
              <%= link_to "Upgrade now", "#", class: "btn btn-sm btn-accent" %>
            </div>
          </div>
        </div>
      <% end %>

      <%# Metric Cards - Hero Row %>
      <div class="dashboard-hero">
        <% if current_user.buyer? %>
          <%# Buyer Metrics %>
          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-blue">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value"><%= Property.published.count rescue 0 %></div>
              <div class="metric-card-label">Properties Available</div>
            </div>
            <div class="metric-card-change metric-card-change-positive">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
              </svg>
              +12 this week
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-green">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value"><%= current_user.property_loves.count rescue 0 %></div>
              <div class="metric-card-label">Saved Properties</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-orange">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value"><%= current_user.offers_made.count rescue 0 %></div>
              <div class="metric-card-label">Offers Made</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-purple">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value"><%= current_user.saved_searches.count rescue 0 %></div>
              <div class="metric-card-label">Saved Searches</div>
            </div>
          </div>
        <% end %>

        <% if current_user.seller? %>
          <%# Seller Metrics %>
          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-blue">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value"><%= current_user.properties.count rescue 0 %></div>
              <div class="metric-card-label">Active Listings</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-teal">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value"><%= current_user.properties.sum { |p| p.property_views.count } rescue 0 %></div>
              <div class="metric-card-label">Total Views</div>
            </div>
            <div class="metric-card-change metric-card-change-positive">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
              </svg>
              +24% this week
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-orange">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value"><%= current_user.properties.joins(:property_enquiries).distinct.count rescue 0 %></div>
              <div class="metric-card-label">Enquiries</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-green">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <% offers_received = Offer.joins(:property).where(properties: { user_id: current_user.id }).count rescue 0 %>
              <div class="metric-card-value"><%= offers_received %></div>
              <div class="metric-card-label">Offers Received</div>
            </div>
            <% if offers_received > 0 %>
              <div class="metric-card-change metric-card-change-positive">
                <%= offers_received %> pending review
              </div>
            <% end %>
          </div>
        <% end %>

        <% if current_user.service_provider? %>
          <%# Provider Metrics %>
          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-blue">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <line x1="19" y1="8" x2="19" y2="14"/>
                <line x1="22" y1="11" x2="16" y2="11"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value">0</div>
              <div class="metric-card-label">New Leads</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-green">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect width="20" height="14" x="2" y="7" rx="2" ry="2"/>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value">0</div>
              <div class="metric-card-label">Active Jobs</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-orange">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <% avg_rating = current_user.reviews_received.average(:overall_rating).to_f.round(1) rescue 0 %>
              <div class="metric-card-value"><%= avg_rating > 0 ? avg_rating : '--' %></div>
              <div class="metric-card-label">Avg Rating</div>
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-card-icon metric-card-icon-purple">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
              </svg>
            </div>
            <div class="metric-card-content">
              <div class="metric-card-value"><%= current_user.reviews_received.count rescue 0 %></div>
              <div class="metric-card-label">Total Reviews</div>
            </div>
          </div>
        <% end %>
      </div>

      <%# Main Dashboard Grid %>
      <div class="dashboard-main">
        <%# Left Column - Main Content %>
        <div class="flex flex-col gap-6">
          <% if current_user.buyer? %>
            <%# Property Matches Panel %>
            <div class="dashboard-panel">
              <div class="dashboard-panel-header">
                <div>
                  <h2 class="dashboard-panel-title">Property Matches</h2>
                  <p class="dashboard-panel-subtitle">Properties that match your search criteria</p>
                </div>
                <div class="dashboard-panel-actions">
                  <%= link_to properties_path, class: "btn btn-sm btn-ghost" do %>
                    View all
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                  <% end %>
                </div>
              </div>

              <% matches = Property.published.limit(3) rescue [] %>
              <% if matches.any? %>
                <div class="property-card-list">
                  <% matches.each do |property| %>
                    <%= link_to property_path(property), class: "property-card property-card-horizontal" do %>
                      <div class="property-card-image">
                        <% if property.hero_image.attached? %>
                          <%= image_tag property.hero_image, alt: property.street_address %>
                        <% else %>
                          <div class="property-card-placeholder">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            </svg>
                          </div>
                        <% end %>
                      </div>
                      <div class="property-card-content">
                        <div class="property-card-price"><%= number_to_currency(property.price, precision: 0) rescue 'Price on request' %></div>
                        <div class="property-card-address"><%= property.street_address %>, <%= property.suburb %></div>
                        <div class="property-card-features">
                          <span><%= property.bedrooms %> bed</span>
                          <span><%= property.bathrooms %> bath</span>
                          <span><%= property.parking_spaces %> car</span>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              <% else %>
                <div class="card-empty">
                  <div class="card-empty-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                  </div>
                  <div class="card-empty-title">No matches yet</div>
                  <div class="card-empty-description">Set up your search criteria to find matching properties</div>
                  <%= link_to "Create saved search", buyer_saved_searches_path, class: "btn btn-sm btn-primary" %>
                </div>
              <% end %>
            </div>
          <% end %>

          <% if current_user.seller? %>
            <%# My Listings Panel %>
            <div class="dashboard-panel">
              <div class="dashboard-panel-header">
                <div>
                  <h2 class="dashboard-panel-title">My Listings</h2>
                  <p class="dashboard-panel-subtitle">Your properties for sale</p>
                </div>
                <div class="dashboard-panel-actions">
                  <%= link_to seller_properties_path, class: "btn btn-sm btn-ghost" do %>
                    View all
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                  <% end %>
                </div>
              </div>

              <% listings = current_user.properties.limit(3) rescue [] %>
              <% if listings.any? %>
                <div class="property-card-list">
                  <% listings.each do |property| %>
                    <%= link_to seller_property_path(property), class: "property-card property-card-horizontal" do %>
                      <div class="property-card-image">
                        <% if property.hero_image.attached? %>
                          <%= image_tag property.hero_image, alt: property.street_address %>
                        <% else %>
                          <div class="property-card-placeholder">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            </svg>
                          </div>
                        <% end %>
                        <% if property.status.present? %>
                          <span class="status-badge status-badge-<%= property.status %>"><%= property.status.titleize %></span>
                        <% end %>
                      </div>
                      <div class="property-card-content">
                        <div class="property-card-price"><%= number_to_currency(property.price, precision: 0) rescue 'Price on request' %></div>
                        <div class="property-card-address"><%= property.street_address %>, <%= property.suburb %></div>
                        <div class="property-card-stats">
                          <span><%= property.property_views.count rescue 0 %> views</span>
                          <span><%= property.property_loves.count rescue 0 %> loves</span>
                          <span><%= property.property_enquiries.count rescue 0 %> enquiries</span>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              <% else %>
                <div class="card-empty">
                  <div class="card-empty-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    </svg>
                  </div>
                  <div class="card-empty-title">No listings yet</div>
                  <div class="card-empty-description">List your first property to start receiving enquiries</div>
                  <%= link_to "List a property", new_seller_property_path, class: "btn btn-sm btn-primary" %>
                </div>
              <% end %>
            </div>
          <% end %>

          <%# Recent Activity Panel %>
          <div class="dashboard-panel">
            <div class="dashboard-panel-header">
              <h2 class="dashboard-panel-title">Recent Activity</h2>
            </div>

            <% activities = current_user.notifications.order(created_at: :desc).limit(5) rescue [] %>
            <% if activities.any? %>
              <div class="activity-feed">
                <% activities.each do |activity| %>
                  <div class="activity-item">
                    <div class="activity-icon activity-icon-blue">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                      </svg>
                    </div>
                    <div class="activity-content">
                      <div class="activity-title"><%= activity.title %></div>
                      <div class="activity-description"><%= activity.message %></div>
                    </div>
                    <span class="activity-time"><%= time_ago_in_words(activity.created_at) %> ago</span>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="card-empty">
                <div class="card-empty-icon">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                  </svg>
                </div>
                <div class="card-empty-title">No recent activity</div>
                <div class="card-empty-description">Your activity will appear here as you use Reasy</div>
              </div>
            <% end %>
          </div>
        </div>

        <%# Right Column - Sidebar Content %>
        <div class="flex flex-col gap-6">
          <%# Quick Actions Panel %>
          <div class="dashboard-panel">
            <div class="dashboard-panel-header">
              <h2 class="dashboard-panel-title">Quick Actions</h2>
            </div>

            <div class="quick-actions">
              <%= link_to ai_conversations_path, class: "quick-action" do %>
                <div class="quick-action-icon" style="background: var(--color-primary-pale); color: var(--color-primary);">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8V4H8"/>
                    <rect width="16" height="12" x="4" y="8" rx="2"/>
                    <path d="M2 14h2"/>
                    <path d="M20 14h2"/>
                    <path d="M15 13v2"/>
                    <path d="M9 13v2"/>
                  </svg>
                </div>
                <div class="quick-action-content">
                  <div class="quick-action-title">Chat with AI</div>
                  <div class="quick-action-description">Get help from our assistants</div>
                </div>
              <% end %>

              <% if current_user.buyer? %>
                <%= link_to properties_path, class: "quick-action" do %>
                  <div class="quick-action-icon" style="background: var(--color-success-pale); color: var(--color-success);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                  </div>
                  <div class="quick-action-content">
                    <div class="quick-action-title">Search Properties</div>
                    <div class="quick-action-description">Find your dream home</div>
                  </div>
                <% end %>
              <% end %>

              <% if current_user.seller? %>
                <%= link_to new_seller_property_path, class: "quick-action" do %>
                  <div class="quick-action-icon" style="background: var(--color-accent-pale); color: var(--color-accent);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 5v14M5 12h14"/>
                    </svg>
                  </div>
                  <div class="quick-action-content">
                    <div class="quick-action-title">List Property</div>
                    <div class="quick-action-description">Add a new listing</div>
                  </div>
                <% end %>
              <% end %>

              <%= link_to conversations_path, class: "quick-action" do %>
                <div class="quick-action-icon" style="background: var(--color-gray-100); color: var(--color-text-secondary);">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
                  </svg>
                </div>
                <div class="quick-action-content">
                  <div class="quick-action-title">Messages</div>
                  <div class="quick-action-description">View conversations</div>
                </div>
              <% end %>
            </div>
          </div>

          <%# AI Assistant Callout %>
          <div class="callout">
            <div class="callout-avatar">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M12 8V4H8"/>
                <rect width="16" height="12" x="4" y="8" rx="2"/>
              </svg>
            </div>
            <div class="callout-content">
              <div class="callout-name">Meet your AI Assistants</div>
              <div class="callout-message">
                Get expert guidance from Max (property), Sage (journey), Nina (negotiation), Doc (documents), Scout (market), and Ally (providers).
              </div>
              <%= link_to "Start chatting", ai_conversations_path, class: "btn btn-sm btn-primary mt-3" %>
            </div>
          </div>

          <%# Stats Summary %>
          <div class="dashboard-panel">
            <div class="dashboard-panel-header">
              <h2 class="dashboard-panel-title">Account Status</h2>
            </div>

            <div class="stats-summary">
              <div class="stats-row">
                <span class="stats-label">Subscription</span>
                <span class="stats-value">
                  <% if current_user.trial? %>
                    <span class="badge badge-warning">Trial</span>
                  <% elsif current_user.active_subscription? %>
                    <span class="badge badge-success">Active</span>
                  <% else %>
                    <span class="badge badge-secondary">Inactive</span>
                  <% end %>
                </span>
              </div>
              <div class="stats-row">
                <span class="stats-label">Verification</span>
                <span class="stats-value">
                  <% if current_user.kyc_verified? %>
                    <span class="badge badge-success">Verified</span>
                  <% else %>
                    <span class="badge badge-secondary">Not verified</span>
                  <% end %>
                </span>
              </div>
              <div class="stats-row">
                <span class="stats-label">Entities</span>
                <span class="stats-value"><%= current_user.entities.count rescue 0 %></span>
              </div>
              <div class="stats-row">
                <span class="stats-label">Co-Users</span>
                <span class="stats-value"><%= current_user.co_users.count rescue 0 %> / 2</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
